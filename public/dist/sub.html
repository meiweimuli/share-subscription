<html lang="zh">

<head>
  <title>订阅管理</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="./assets/js/vue.global.prod.js"></script>
  <!-- import CSS -->
  <link rel="stylesheet" href="./assets/css/element-plus.css">
  <!-- import JavaScript -->
  <script src="assets/js/element-plus.full.min.js"></script>
  <script src="./assets/js/filesize.min.js"></script>
  <script src="./assets/js/dayjs.min.js"></script>
  <script src="./assets/js/dayjs-utc.js"></script>
  <script src="./assets/js/dayjs-timezone.js"></script>
  <style>
      .match-file {
          --el-table-tr-bg-color: var(--el-color-success-light-8);
      }

      .share_url_invalid {
          --el-table-tr-bg-color: var(--el-color-danger-light-8);
      }
  </style>
</head>

<body>
<div id="app">

</div>
<script type="module">
  import { cloneDeep } from './assets/js/lodash-es.js'
  import { FolderSelect } from './src/components/FolderSelect.js'
  import { client } from './src/utils/client.js'
  import { ShareSaverDialog } from './src/views/sub/ShareSaverDialog.js'
  import { SubLogDialog } from './src/views/sub/SubLogDialog.js'
  import { formatTime } from './src/utils/time.js'
  import { SettingDialog } from './src/components/SettingDialog.js'

  dayjs.extend(dayjs_plugin_utc)
  dayjs.extend(dayjs_plugin_timezone)

  const { createApp, ref, watch, onMounted, computed, nextTick } = Vue
  const { ElMessage } = window.ElementPlus


  const app = createApp({
    setup() {

      //列表
      const loading = ref(false)
      const subscriptionList = ref([])

      async function loadSubscriptionList() {
        loading.value = true
        const resp = await client.get('api/sub/list?per_page=100000')
        if (resp?.data?.content) {
          for (let sub of resp.data.content) {
            sub.lastQueryTime = sub.last_query_time && dayjs(sub.last_query_time)
          }
          subscriptionList.value = resp.data.content
        } else {
          subscriptionList.value = []
        }
        loading.value = false
      }

      onMounted(loadSubscriptionList)

      //切换是否启用
      async function changeDisabled(subscription, disabled) {
        if (disabled) {
          await client.post(`api/sub/disable?id=${subscription.id}`)
        } else {
          await client.post(`api/sub/enable?id=${subscription.id}`)
        }
      }

      //修改、添加
      const editing = ref(false)
      const editingSubscription = ref()
      const saveFormRef = ref()

      const toAdd = async () => {
        editingSubscription.value = {
          'name': '',
          'disabled': true,
          'share_url': '',
          'share_secret': '',
          'target_folder_id': '',
          'match_regex': '',
          'replace_regex': '^.*?((?<![Ss\\d])(?!.*[Ee]\\d+)\\d\\d(?!\\d)|(?<=[Ee])\\d+).*?(\\.(?:mp4|mkv|(?:(?:[a-zA-Z]{2,3}\\.)?(?:ass|srt))))$',
          'rename_target': '',
          'ignore_same_name': true
        }
        editing.value = true
      }

      const toEdit = async (subscription) => {
        editingSubscription.value = cloneDeep(subscription)
        editing.value = true
      }

      const doSave = async () => {
        console.log(editingSubscription.value)

        try {
          await saveFormRef.value.validate()
        } catch {
          return
        }

        const saveUrl = editingSubscription.value.id ? 'api/sub/update' : 'api/sub/create'

        const resp = await client.post(saveUrl, editingSubscription.value)
        if (resp?.code !== 200) {
          return
        }
        ElMessage.success('保存成功')
        editing.value = false
        await loadSubscriptionList()
      }

      //删除
      const doDelete = async (subscription) => {
        const resp = await client.post(`api/sub/delete?id=${subscription.id}`)
        if (!resp) {
          return
        }
        ElMessage.success('删除成功')
        await loadSubscriptionList()
      }

      //执行
      async function execSub(subscription) {
        const resp = await client.post(`api/sub/exec?id=${subscription.id}`)
        if (resp?.code === 200) {
          ElMessage.success('执行成功')
        }
        await loadSubscriptionList()
      }

      //预览
      const previewing = ref(false)
      const previewingSubscription = ref()
      const shareFiles = ref([])
      const savedFiles = ref([])
      const previewTable = ref()
      const toPreview = async (subscription) => {
        const subGetResp = await client.get(`api/sub/get?id=${subscription.id}`)
        subscription = subGetResp?.data
        if (!subscription) {
          return
        }
        if (!subscription.disabled) {
          ElMessage.warning('关闭的任务才能预览')
          return
        }

        previewingSubscription.value = subscription
        shareFiles.value = []
        previewing.value = true

        const shareListResp = await client.post('api/share/list', {
          share_url: subscription.share_url,
          share_secret: subscription.share_secret
        })
        if (!shareListResp?.data) {
          return
        }
        shareFiles.value = shareListResp.data

        let matchRegex, replaceRegex
        try {
          matchRegex = new RegExp(subscription.match_regex)
          replaceRegex = new RegExp(subscription.replace_regex)
        } catch {
        }
        for (const shareFile of shareFiles.value) {
          shareFile.readableSize = filesize(shareFile.size)
          shareFile.createTime = shareFile.created && dayjs(shareFile.created)
          shareFile.match = !!matchRegex && matchRegex.test(shareFile.name)
          if (shareFile.match && subscription.rename_target && replaceRegex) {
            try {
              shareFile.replaceName = shareFile.name.replace(replaceRegex, subscription.rename_target)
            } catch {
            }
          }
          shareFile.replaceName = shareFile.match ? shareFile.replaceName || shareFile.name : '-'
        }
        await nextTick()
        const savedFileIds = subscription.saved_file_ids.split(',')
        for (const shareFile of shareFiles.value) {
          if (savedFileIds.indexOf(shareFile.id) > -1) {
            previewTable.value.toggleRowSelection(shareFile)
          }
        }
      }

      const handleSelectionChange = async (selection) => {
        savedFiles.value = selection
      }

      const saveSavedFiles = async () => {
        console.log(savedFiles.value.map(item => item.id).join(','))
        previewingSubscription.value.saved_file_ids = savedFiles.value.map(item => item.id).join(',')
        const resp = await client.post('api/sub/update', previewingSubscription.value)
        if (!resp) {
          return
        }
        ElMessage.success('保存成功')
        previewing.value = false
      }

      //分享保存
      const showShareSaverDialog = ref(false)
      //记录
      const showSubLogDialog = ref(false)
      //配置token
      const showSettingDialog = ref(false)

      return {
        loading,
        subscriptionList,
        loadSubscriptionList,
        changeDisabled,

        execSub,

        toAdd,
        toEdit,
        editing,
        editingSubscription,
        saveFormRef,
        doSave,

        doDelete,

        toPreview,
        previewing,
        shareFiles,
        savedFiles,
        previewTable,
        handleSelectionChange,
        saveSavedFiles,

        showShareSaverDialog,
        showSubLogDialog,
        showSettingDialog,

        formatTime
      }
    }
  })
  app.component('FolderSelect', FolderSelect)
  app.component('ShareSaverDialog', ShareSaverDialog)
  app.component('SubLogDialog', SubLogDialog)
  app.component('SettingDialog', SettingDialog)
  app.use(window.ElementPlus)
  app.mount('#app')
</script>
</body>

</html>