<html>

<head>
  <title>电影搜索</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="./assets/js/vue.global.prod.js"></script>
  <!-- import CSS -->
  <link rel="stylesheet" href="./assets/css/element-plus.css">
  <!-- import JavaScript -->
  <script src="./assets/js/element-plus.full.min.js"></script>
  <script src="./assets/js/axios.min.js"></script>
</head>

<body>
<div id="app">
  <el-card>
    <div>
      <el-form-item label="imdbId查询">
        <el-input v-model="imdbIdQuery"
                  @keyup.enter.native="doImdbIdQuery"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" :disabled="!imdbIdQuery" @click="doImdbIdQuery">查询</el-button>
      </el-form-item>

      <el-descriptions class="margin-top" title="电影" :column="1" border :loading="searchingmovie">
        <el-descriptions-item>
          <template #label>
            电影文件夹
          </template>
          <div @click="doCopy(movieFolderName)">{{ movieFolderName }}</div>
        </el-descriptions-item>
        <template v-for="(seasonFolderName,index) in seasonFolderNames">
          <el-descriptions-item>
            <template #label>
              季文件夹{{ index + 1}}
            </template>
            <div @click="doCopy(seasonFolderName)">{{ seasonFolderName }}</div>
          </el-descriptions-item>
        </template>
      </el-descriptions>

    </div>
  </el-card>
  <el-card>
    <div>
      <!-- <el-form-item label="ApiKey"> <el-input v-model="apiKey"></el-input></el-form-item> -->
      <el-form-item label="文本查询">
        <el-input v-model="query" @keyup.enter.native="doQuery"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" :disabled="!query" @click="doQuery">查询</el-button>
      </el-form-item>
      <el-table :data="movieList" v-loading="quering">
        <el-table-column prop="title" label="英文标题">
          <template v-slot="{row}">
            <div @click="doCopy(row.title)">{{ row.title }}</div>
          </template>
        </el-table-column>
        <el-table-column prop="original_title" label="原始标题">
          <template v-slot="{row}">
            <div @click="doCopy(row.original_title)">{{ row.original_title }}</div>
          </template>
        </el-table-column>
        <el-table-column prop="chinese_title" label="中文标题">
          <template v-slot="{row}">
            <div @click="doCopy(row.chinese_title)">{{ row.chinese_title }}</div>
          </template>
        </el-table-column>
        <el-table-column prop="release_date" label="年份"></el-table-column>
        <el-table-column prop="external_ids.imdb_id" label="imdbId">
          <template v-slot="{row}">
            <div @click="doCopy(row.external_ids?.imdb_id)">{{ row.external_ids?.imdb_id }}</div>
          </template>
        </el-table-column>
        <el-table-column fixed="right" label="操作" width="120">
          <template v-slot="{row}">
            <el-button link type="primary" size="small" @click.prevent="selectmovie(row.id)">
              查看
            </el-button>
          </template>
        </el-table-column>
      </el-table>

    </div>
  </el-card>

</div>
<script type="module">
  import { keyBy, cloneDeep, groupBy } from './assets/js/lodash-es.js'

  const { createApp, ref, watch, onMounted, computed } = Vue
  const { ElMessage } = ElementPlus

  const tmdbApiKey = localStorage.getItem('tmdb_token')
  axios.interceptors.request.use((config) => {
    config.params = Object.assign({ 'api_key': tmdbApiKey }, config.params)
    return config
  }, function(error) {
    return Promise.reject(error)
  })

  axios.interceptors.response.use(function(response) {
    if (!(response.status === 200)) {
      ElMessage.error('接口请求失败')
      return undefined
    }
    return response.data || 'success'
  }, function(error) {
    console.log(error)
    ElMessage.error('接口请求失败')
    return undefined
  })

  const app = createApp({
    setup() {

      const movieList = ref([])

      const query = ref('')
      const quering = ref(false)
      const doQuery = async () => {
        quering.value = true
        const result = await axios.get('https://api.themoviedb.org/3/search/movie', { params: { query: query.value } })
        movieList.value = result.results
        quering.value = false

        for (const movie of movieList.value) {
          (async () => {
            const id = movie.id
            const externalIds = await axios.get(`https://api.themoviedb.org/3/movie/${id}/external_ids`)
            const translations = await axios.get(`https://api.themoviedb.org/3/movie/${id}/translations`)
            movie.external_ids = externalIds
            movie.translations = translations?.translations ?? []
            movie.chinese_title = movie.translations.find(item => item.iso_3166_1 === 'CN')?.data?.title
              || movie.translations.find(item => item.iso_3166_1 === 'SG')?.data?.title
              || (movie.original_language === 'zh' && movie.original_title) || ''
          })()
        }
      }

      const doCopy = (data) => {
        const tempInput = document.createElement('input')
        tempInput.value = data
        document.body.append(tempInput)
        tempInput.select()
        document.execCommand('copy')
        ElMessage.success('复制成功')
        tempInput.remove()
      }

      const imdbIdQuery = ref('')
      const movieDetail = ref({})
      const movieFolderName = computed(() => {
        const detail = movieDetail.value
        const imdbFragment = detail.external_ids?.imdb_id ? ` {imdb-${detail.external_ids?.imdb_id}}` : ''
        return detail.id ? `${detail.chinese_title} (${detail.release_date?.substring(0, 4) ?? ''}) {tmdb-${detail.id}}${imdbFragment} [${detail.original_title ?? ''}] [${detail.title ?? ''}]` : ''
      })
      const searchingmovie = ref(false)
      const doImdbIdQuery = async () => {
        const findResult = await axios.get(`https://api.themoviedb.org/3/find/${imdbIdQuery.value}?external_source=imdb_id`)
        const movieId = findResult?.movie_results?.[0]?.id
        if (!movieId) {
          ElMessage.error('没有找到')
          return
        }
        selectmovie(movieId)
      }
      const selectmovie = async (id) => {
        searchingmovie.value = true
        const movie = await axios.get(`https://api.themoviedb.org/3/movie/${id}`)
        const externalIds = await axios.get(`https://api.themoviedb.org/3/movie/${id}/external_ids`)
        const translations = await axios.get(`https://api.themoviedb.org/3/movie/${id}/translations`)
        movie.external_ids = externalIds
        movie.translations = translations?.translations ?? []
        movie.chinese_title = movie.translations.find(item => item.iso_3166_1 === 'CN')?.data?.title
          || movie.translations.find(item => item.iso_3166_1 === 'SG')?.data?.title
          || (movie.original_language === 'zh' && movie.original_title) || ''
        movieDetail.value = movie
        searchingmovie.value = false
      }

      return {
        movieList,
        query,
        quering,
        doQuery,
        doCopy,

        imdbIdQuery,
        searchingmovie,
        selectmovie,
        movieDetail,
        doImdbIdQuery,
        movieFolderName
      }
    }
  })
  app.use(ElementPlus)
  app.mount('#app')
</script>
</body>

</html>