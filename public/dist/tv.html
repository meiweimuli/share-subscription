<html>

<head>
  <title>节目搜索</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="./assets/js/vue.global.prod.js"></script>
  <!-- import CSS -->
  <link rel="stylesheet" href="./assets/css/element-plus.css">
  <!-- import JavaScript -->
  <script src="assets/js/element-plus.full.min.js"></script>
  <script src="./assets/js/axios.min.js"></script>
</head>

<body>
<div id="app">
  <el-card>
    <div>
      <el-form-item label="imdbId查询">
        <el-input v-model="imdbIdQuery"
                  @keyup.enter.native="doImdbIdQuery"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" :disabled="!imdbIdQuery" @click="doImdbIdQuery">查询</el-button>
      </el-form-item>

      <el-descriptions class="margin-top" title="节目" :column="1" border :loading="searchingTv">
        <el-descriptions-item>
          <template #label>
            节目文件夹
          </template>
          <div @click="doCopy(tvFolderName)">{{ tvFolderName }}</div>
        </el-descriptions-item>
        <el-descriptions-item>
          <template #label>
            infuse文件名正则
          </template>
          <div
            @click="doCopy('^.*?((?<![Ss\\d])(?!.*[Ee]\\d+)\\d\\d(?!\\d)|(?<=[Ee])\\d+).*?(\\.(?:mp4|mkv|(?:(?:[a-zA-Z]{2,3}\.)?(?:ass|srt))))$')">
            ^.*?((?&lt;![Ss\d])(?!.*[Ee]\d+)\d\d(?!\d)|(?&lt;=[Ee])\d+).*?(\.(?:mp4|mkv|(?:(?:[a-zA-Z]{2,3}\.)?(?:ass|srt))))$
          </div>
        </el-descriptions-item>
        <el-descriptions-item>
          <template #label>
            infuse文件名
          </template>
          <div @click="doCopy(infuseEpisodeName)">{{ infuseEpisodeName }}</div>
        </el-descriptions-item>
        <template v-for="(seasonFolderName,index) in seasonFolderNames">
          <el-descriptions-item>
            <template #label>
              季文件夹{{ index + 1}}
            </template>
            <div @click="doCopy(seasonFolderName)">{{ seasonFolderName }}</div>
          </el-descriptions-item>
        </template>
      </el-descriptions>

    </div>
  </el-card>
  <el-card>
    <div>
      <!-- <el-form-item label="ApiKey"> <el-input v-model="apiKey"></el-input></el-form-item> -->
      <el-form-item label="文本查询">
        <el-input v-model="query" @keyup.enter.native="doQuery"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" :disabled="!query" @click="doQuery">查询</el-button>
      </el-form-item>

      <el-table :data="tvList" v-loading="quering">
        <el-table-column prop="name" label="英文标题">
          <template v-slot="{row}">
            <div @click="doCopy(row.name)">{{ row.name }}</div>
          </template>
        </el-table-column>
        <el-table-column prop="original_name" label="原始标题"></el-table-column>
        <el-table-column prop="chinese_name" label="中文标题">
          <template v-slot="{row}">
            <div @click="doCopy(row.chinese_name)">{{ row.chinese_name }}</div>
          </template>
        </el-table-column>
        <el-table-column prop="first_air_date" label="年份"></el-table-column>
        <el-table-column prop="external_ids.imdb_id" label="imdbId">
          <template v-slot="{row}">
            <div @click="doCopy(row.external_ids?.imdb_id)">{{ row.external_ids?.imdb_id }}</div>
          </template>
        </el-table-column>
        <el-table-column fixed="right" label="操作" width="120">
          <template v-slot="{row}">
            <el-button link type="primary" size="small" @click.prevent="selectTv(row.id)">
              查看
            </el-button>
          </template>
        </el-table-column>
      </el-table>

    </div>
  </el-card>

</div>
<script type="module">
  import { keyBy, cloneDeep, groupBy } from './assets/js/lodash-es.js'

  const { createApp, ref, watch, onMounted, computed } = Vue
  const { ElMessage } = ElementPlus

  const tmdbApiKey = localStorage.getItem('tmdb_token')
  axios.interceptors.request.use((config) => {
    config.params = Object.assign({ 'api_key': tmdbApiKey }, config.params)
    return config
  }, function(error) {
    return Promise.reject(error)
  })

  axios.interceptors.response.use(function(response) {
    if (!(response.status === 200)) {
      ElMessage.error('接口请求失败')
      return undefined
    }
    return response.data || 'success'
  }, function(error) {
    console.log(error)
    ElMessage.error('接口请求失败')
    return undefined
  })

  const app = createApp({
    setup() {

      const tvList = ref([])

      const query = ref('')
      const quering = ref(false)
      const doQuery = async () => {
        quering.value = true
        const result = await axios.get('https://api.themoviedb.org/3/search/tv', { params: { query: query.value } })
        tvList.value = result.results
        quering.value = false

        for (const tv of tvList.value) {
          (async () => {
            const id = tv.id
            const externalIds = await axios.get(`https://api.themoviedb.org/3/tv/${id}/external_ids`)
            const translations = await axios.get(`https://api.themoviedb.org/3/tv/${id}/translations`)
            tv.external_ids = externalIds
            tv.translations = translations?.translations ?? []
            tv.chinese_name = tv.translations.find(item => item.iso_3166_1 === 'CN')?.data?.name
              || tv.translations.find(item => item.iso_3166_1 === 'SG')?.data?.name
              || (tv.original_language === 'zh' && tv.original_name) || ''
          })()
        }
      }

      const doCopy = (data) => {
        const tempInput = document.createElement('input')
        tempInput.value = data
        document.body.append(tempInput)
        tempInput.select()
        document.execCommand('copy')
        ElMessage.success('复制成功')
        tempInput.remove()
      }

      const imdbIdQuery = ref('')
      const tvDetail = ref({})
      const tvFolderName = computed(() => {
        const detail = tvDetail.value
        const imdbFragment = detail.external_ids?.imdb_id ? ` {imdb-${detail.external_ids?.imdb_id}}` : ''
        return detail.id ? `${detail.chinese_name} (${detail.first_air_date?.substring(0, 4) ?? ''}) {tmdb-${detail.id}}${imdbFragment} [${detail.original_name ?? ''}] [${detail.name ?? ''}]` : ''
      })
      const infuseEpisodeName = computed(() => {
        const detail = tvDetail.value
        return detail.id ? `${detail.chinese_name} - S01E$1$2` : ''
      })
      const seasonFolderNames = computed(() => tvDetail.value.seasons ? tvDetail.value.seasons.map(season => `Season ${`${season.season_number}`.padStart(2, '0')} [${season.name}]`) : [])
      const seasonList = ref([])
      const searchingTv = ref(false)
      const doImdbIdQuery = async () => {
        const findResult = await axios.get(`https://api.themoviedb.org/3/find/${imdbIdQuery.value}?external_source=imdb_id`)
        const tvId = findResult?.tv_results?.[0]?.id
        if (!tvId) {
          ElMessage.error('没有找到')
          return
        }
        selectTv(tvId)
      }
      const selectTv = async (id) => {
        searchingTv.value = true
        const tv = await axios.get(`https://api.themoviedb.org/3/tv/${id}`)
        const externalIds = await axios.get(`https://api.themoviedb.org/3/tv/${id}/external_ids`)
        const translations = await axios.get(`https://api.themoviedb.org/3/tv/${id}/translations`)
        tv.external_ids = externalIds
        tv.translations = translations?.translations ?? []
        tv.chinese_name = tv.translations.find(item => item.iso_3166_1 === 'CN')?.data?.name
          || tv.translations.find(item => item.iso_3166_1 === 'SG')?.data?.name
          || (tv.original_language === 'zh' && tv.original_name) || ''
        tvDetail.value = tv
        searchingTv.value = false
      }

      return {
        tvList,
        query,
        quering,
        doQuery,
        doCopy,

        imdbIdQuery,
        searchingTv,
        selectTv,
        tvDetail,
        seasonList,
        doImdbIdQuery,
        tvFolderName,
        infuseEpisodeName,
        seasonFolderNames
      }
    }
  })
  app.use(ElementPlus)
  app.mount('#app')
</script>
</body>

</html>